<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zwei-Spieler Schach Deluxe</title>
<style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #222;
    color: white;
    font-family: sans-serif;
    flex-direction: column;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 80px);
    grid-template-rows: repeat(8, 80px);
    border: 4px solid #555;
  }
  .square {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    cursor: pointer;
    position: relative;
  }
  .light { background: #eee; color: black; }
  .dark { background: #444; color: white; }
  .highlight { outline: 3px solid yellow; }
  .dot {
    position: absolute;
    width: 20px;
    height: 20px;
    background: rgba(255, 255, 0, 0.7);
    border-radius: 50%;
    pointer-events: none;
  }
  h1 { margin-bottom: 10px; }
  h2 { margin-top: 10px; }
</style>
</head>
<body>
<h1>♟ Zwei-Spieler Schach Deluxe ♟</h1>
<div id="board"></div>
<h2 id="turn">Weiß am Zug</h2>
<h3 id="status"></h3>
<script>
const boardEl = document.getElementById("board");
const turnEl = document.getElementById("turn");
const statusEl = document.getElementById("status");

let board = [
  ["r","n","b","q","k","b","n","r"],
  ["p","p","p","p","p","p","p","p"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["P","P","P","P","P","P","P","P"],
  ["R","N","B","Q","K","B","N","R"],
];

const pieces = {
  "K":"♔","Q":"♕","R":"♖","B":"♗","N":"♘","P":"♙",
  "k":"♚","q":"♛","r":"♜","b":"♝","n":"♞","p":"♟"
};

let selected = null;
let turn = "white";
let possibleMoves = [];
let whiteKingMoved=false, blackKingMoved=false;
let whiteRookMoved=[false,false], blackRookMoved=[false,false];
let enPassant = null; // speichert En-Passant-Ziel

function render() {
  boardEl.innerHTML = "";
  for (let r=0; r<8; r++) {
    for (let c=0; c<8; c++) {
      const sq = document.createElement("div");
      sq.classList.add("square", (r+c)%2==0?"light":"dark");
      sq.dataset.r = r;
      sq.dataset.c = c;
      const piece = board[r][c];
      if (piece) sq.textContent = pieces[piece];
      if (selected && selected.r===r && selected.c===c) {
        sq.classList.add("highlight");
      }
      // Punkte für mögliche Züge
      if(possibleMoves.some(m=>m.r===r && m.c===c)){
        const dot = document.createElement("div");
        dot.className = "dot";
        sq.appendChild(dot);
      }
      boardEl.appendChild(sq);
    }
  }
  turnEl.textContent = (turn==="white"?"Weiß":"Schwarz") + " am Zug";
}

function isWhite(piece){ return piece && piece===piece.toUpperCase(); }
function isBlack(piece){ return piece && piece===piece.toLowerCase(); }

boardEl.addEventListener("click", e=>{
  if(!e.target.classList.contains("square")) return;
  const r = +e.target.dataset.r;
  const c = +e.target.dataset.c;
  const piece = board[r][c];

  if(selected){
    // prüfen, ob Zug möglich
    if(possibleMoves.some(m=>m.r===r && m.c===c)){
      makeMove(selected.r, selected.c, r, c);
      turn = (turn==="white"?"black":"white");
      checkGameState();
    }
    selected = null;
    possibleMoves = [];
  } else {
    if(piece && ((turn==="white" && isWhite(piece)) || (turn==="black" && isBlack(piece)))){
      selected = {r,c};
      possibleMoves = getValidMoves(r,c);
    }
  }
  render();
});

function makeMove(r1,c1,r2,c2){
  const piece = board[r1][c1];
  // Rochade
  if(piece==="K" && Math.abs(c2-c1)===2){
    if(c2===6){ board[7][5]=board[7][7]; board[7][7]=""; }
    else { board[7][3]=board[7][0]; board[7][0]=""; }
    whiteKingMoved=true;
  }
  if(piece==="k" && Math.abs(c2-c1)===2){
    if(c2===6){ board[0][5]=board[0][7]; board[0][7]=""; }
    else { board[0][3]=board[0][0]; board[0][0]=""; }
    blackKingMoved=true;
  }
  // En passant
  if(piece==="P" && enPassant && r2===enPassant.r && c2===enPassant.c){
    board[r2+1][c2]="";
  }
  if(piece==="p" && enPassant && r2===enPassant.r && c2===enPassant.c){
    board[r2-1][c2]="";
  }
  // Zug
  board[r2][c2] = piece;
  board[r1][c1] = "";
  // Bauern-Umwandlung
  if(piece==="P" && r2===0) board[r2][c2]="Q";
  if(piece==="p" && r2===7) board[r2][c2]="q";
  // En passant Möglichkeit setzen
  enPassant=null;
  if(piece==="P" && r1===6 && r2===4) enPassant={r:5,c:c1};
  if(piece==="p" && r1===1 && r2===3) enPassant={r:2,c:c1};
}

function getValidMoves(r,c){
  let moves=[];
  const piece = board[r][c];
  if(!piece) return moves;
  const add=(rr,cc)=>{
    if(rr<0||rr>=8||cc<0||cc>=8) return;
    const target = board[rr][cc];
    if((turn==="white" && isWhite(target))||(turn==="black" && isBlack(target))) return;
    moves.push({r:rr,c:cc});
  };
  const addSlide=(dr,dc)=>{
    let rr=r+dr, cc=c+dc;
    while(rr>=0&&rr<8&&cc>=0&&cc<8){
      const target=board[rr][cc];
      if(!target) moves.push({r:rr,c:cc});
      else {
        if((turn==="white"&&isBlack(target))||(turn==="black"&&isWhite(target))) moves.push({r:rr,c:cc});
        break;
      }
      rr+=dr; cc+=dc;
    }
  };
  switch(piece.toLowerCase()){
    case "p":
      if(isWhite(piece)){
        if(!board[r-1][c]) add(r-1,c);
        if(r===6 && !board[5][c] && !board[4][c]) add(4,c);
        if(board[r-1] && isBlack(board[r-1][c-1])) add(r-1,c-1);
        if(board[r-1] && isBlack(board[r-1][c+1])) add(r-1,c+1);
        if(enPassant && enPassant.r===r-1 && Math.abs(enPassant.c-c)===1) moves.push(enPassant);
      } else {
        if(!board[r+1][c]) add(r+1,c);
        if(r===1 && !board[2][c] && !board[3][c]) add(3,c);
        if(board[r+1] && isWhite(board[r+1][c-1])) add(r+1,c-1);
        if(board[r+1] && isWhite(board[r+1][c+1])) add(r+1,c+1);
        if(enPassant && enPassant.r===r+1 && Math.abs(enPassant.c-c)===1) moves.push(enPassant);
      }
      break;
    case "r":
      addSlide(1,0); addSlide(-1,0); addSlide(0,1); addSlide(0,-1);
      break;
    case "n":
      [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(d=>add(r+d[0],c+d[1]));
      break;
    case "b":
      addSlide(1,1); addSlide(1,-1); addSlide(-1,1); addSlide(-1,-1);
      break;
    case "q":
      addSlide(1,0); addSlide(-1,0); addSlide(0,1); addSlide(0,-1);
      addSlide(1,1); addSlide(1,-1); addSlide(-1,1); addSlide(-1,-1);
      break;
    case "k":
      for(let dr=-1;dr<=1;dr++){
        for(let dc=-1;dc<=1;dc++){
          if(dr||dc) add(r+dr,c+dc);
        }
      }
      // Rochade prüfen
      if(turn==="white" && !whiteKingMoved && r===7 && c===4){
        if(!board[7][5] && !board[7][6] && board[7][7]==="R") moves.push({r:7,c:6});
        if(!board[7][3] && !board[7][2] && !board[7][1] && board[7][0]==="R") moves.push({r:7,c:2});
      }
      if(turn==="black" && !blackKingMoved && r===0 && c===4){
        if(!board[0][5] && !board[0][6] && board[0][7]==="r") moves.push({r:0,c:6});
        if(!board[0][3] && !board[0][2] && !board[0][1] && board[0][0]==="r") moves.push({r:0,c:2});
      }
      break;
  }
  return moves;
}

function checkGameState(){
  // prüfen ob König im Schach
  let kingPos=null;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    if(turn==="white" && board[r][c]==="K") kingPos={r,c};
    if(turn==="black" && board[r][c]==="k") kingPos={r,c};
  }
  let inCheck=false;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p) continue;
    if((turn==="white"&&isBlack(p))||(turn==="black"&&isWhite(p))){
      const moves=getValidMoves(r,c);
      if(moves.some(m=>m.r===kingPos.r&&m.c===kingPos.c)) inCheck=true;
    }
  }
  if(inCheck) statusEl.textContent="⚠ "+(turn==="white"?"Weiß":"Schwarz")+" ist im Schach!";
  else statusEl.textContent="";
}
render();
</script>
</body>
</html>
