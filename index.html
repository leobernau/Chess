<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zwei-Spieler Schach Deluxe</title>
<style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #222;
    color: white;
    font-family: sans-serif;
    flex-direction: column;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 80px);
    grid-template-rows: repeat(8, 80px);
    border: 4px solid #555;
  }
  .square {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    cursor: pointer;
    position: relative;
  }
  .light { background: #eee; color: black; }
  .dark { background: #444; color: white; }
  .highlight { outline: 3px solid yellow; }
  .dot {
    position: absolute;
    width: 20px;
    height: 20px;
    background: rgba(255, 255, 0, 0.7);
    border-radius: 50%;
    pointer-events: none;
  }
  h1 { margin-bottom: 10px; }
  h2 { margin-top: 10px; }
  h3 { margin-top: 5px; color: #f88; }
</style>
</head>
<body>
<h1>‚ôü Zwei-Spieler Schach Deluxe ‚ôü</h1>
<div id="board"></div>
<h2 id="turn">Wei√ü am Zug</h2>
<h3 id="status"></h3>
<script>
const boardEl = document.getElementById("board");
const turnEl = document.getElementById("turn");
const statusEl = document.getElementById("status");

let board = [
  ["r","n","b","q","k","b","n","r"],
  ["p","p","p","p","p","p","p","p"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["P","P","P","P","P","P","P","P"],
  ["R","N","B","Q","K","B","N","R"],
];

const pieces = {
  "K":"‚ôî","Q":"‚ôï","R":"‚ôñ","B":"‚ôó","N":"‚ôò","P":"‚ôô",
  "k":"‚ôö","q":"‚ôõ","r":"‚ôú","b":"‚ôù","n":"‚ôû","p":"‚ôü"
};

let selected = null;
let turn = "white";
let possibleMoves = [];
let enPassant = null;

function render() {
  boardEl.innerHTML = "";
  for (let r=0; r<8; r++) {
    for (let c=0; c<8; c++) {
      const sq = document.createElement("div");
      sq.classList.add("square", (r+c)%2==0?"light":"dark");
      sq.dataset.r = r;
      sq.dataset.c = c;
      const piece = board[r][c];
      if (piece) sq.textContent = pieces[piece];
      if (selected && selected.r===r && selected.c===c) {
        sq.classList.add("highlight");
      }
      if(possibleMoves.some(m=>m.r===r && m.c===c)){
        const dot = document.createElement("div");
        dot.className = "dot";
        sq.appendChild(dot);
      }
      boardEl.appendChild(sq);
    }
  }
  turnEl.textContent = (turn==="white"?"Wei√ü":"Schwarz") + " am Zug";
}

function isWhite(p){ return p && p===p.toUpperCase(); }
function isBlack(p){ return p && p===p.toLowerCase(); }

boardEl.addEventListener("click", e=>{
  if(!e.target.classList.contains("square")) return;
  if(gameOver) return;
  const r = +e.target.dataset.r;
  const c = +e.target.dataset.c;
  const piece = board[r][c];

  if(selected){
    if(possibleMoves.some(m=>m.r===r && m.c===c)){
      makeMove(selected.r, selected.c, r, c);
      turn = (turn==="white"?"black":"white");
      checkGameState();
    }
    selected = null;
    possibleMoves = [];
  } else {
    if(piece && ((turn==="white" && isWhite(piece)) || (turn==="black" && isBlack(piece)))){
      selected = {r,c};
      possibleMoves = getValidMoves(r,c,true);
    }
  }
  render();
});

function makeMove(r1,c1,r2,c2){
  const piece = board[r1][c1];
  // En passant
  if(piece==="P" && enPassant && r2===enPassant.r && c2===enPassant.c) board[r2+1][c2]="";
  if(piece==="p" && enPassant && r2===enPassant.r && c2===enPassant.c) board[r2-1][c2]="";
  // Zug
  board[r2][c2] = piece;
  board[r1][c1] = "";
  // Umwandlung
  if(piece==="P" && r2===0) board[r2][c2]="Q";
  if(piece==="p" && r2===7) board[r2][c2]="q";
  // neue En passant M√∂glichkeit
  enPassant=null;
  if(piece==="P" && r1===6 && r2===4) enPassant={r:5,c:c1};
  if(piece==="p" && r1===1 && r2===3) enPassant={r:2,c:c1};
}

function getValidMoves(r,c,filterCheck){
  let moves=[];
  const piece = board[r][c];
  if(!piece) return moves;
  const add=(rr,cc)=>{
    if(rr<0||rr>=8||cc<0||cc>=8) return;
    const t = board[rr][cc];
    if((turn==="white" && isWhite(t))||(turn==="black" && isBlack(t))) return;
    moves.push({r:rr,c:cc});
  };
  const addSlide=(dr,dc)=>{
    let rr=r+dr, cc=c+dc;
    while(rr>=0&&rr<8&&cc>=0&&cc<8){
      const t=board[rr][cc];
      if(!t) moves.push({r:rr,c:cc});
      else { if((turn==="white"&&isBlack(t))||(turn==="black"&&isWhite(t))) moves.push({r:rr,c:cc}); break; }
      rr+=dr; cc+=dc;
    }
  };
  switch(piece.toLowerCase()){
    case "p":
      if(isWhite(piece)){
        if(!board[r-1][c]) add(r-1,c);
        if(r===6 && !board[5][c] && !board[4][c]) add(4,c);
        if(board[r-1] && isBlack(board[r-1][c-1])) add(r-1,c-1);
        if(board[r-1] && isBlack(board[r-1][c+1])) add(r-1,c+1);
        if(enPassant && enPassant.r===r-1 && Math.abs(enPassant.c-c)===1) moves.push(enPassant);
      } else {
        if(!board[r+1][c]) add(r+1,c);
        if(r===1 && !board[2][c] && !board[3][c]) add(3,c);
        if(board[r+1] && isWhite(board[r+1][c-1])) add(r+1,c-1);
        if(board[r+1] && isWhite(board[r+1][c+1])) add(r+1,c+1);
        if(enPassant && enPassant.r===r+1 && Math.abs(enPassant.c-c)===1) moves.push(enPassant);
      }
      break;
    case "r": addSlide(1,0); addSlide(-1,0); addSlide(0,1); addSlide(0,-1); break;
    case "n": [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(d=>add(r+d[0],c+d[1])); break;
    case "b": addSlide(1,1); addSlide(1,-1); addSlide(-1,1); addSlide(-1,-1); break;
    case "q": addSlide(1,0); addSlide(-1,0); addSlide(0,1); addSlide(0,-1); addSlide(1,1); addSlide(1,-1); addSlide(-1,1); addSlide(-1,-1); break;
    case "k":
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++) if(dr||dc) add(r+dr,c+dc);
      break;
  }
  // Schachpr√ºfung filtern
  if(filterCheck){
    moves = moves.filter(m=>{
      let backup = JSON.parse(JSON.stringify(board));
      makeMove(r,c,m.r,m.c);
      let inCheck=isKingInCheck(turn);
      board=backup;
      return !inCheck;
    });
  }
  return moves;
}

function isKingInCheck(color){
  let kingPos=null;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    if(color==="white" && board[r][c]==="K") kingPos={r,c};
    if(color==="black" && board[r][c]==="k") kingPos={r,c};
  }
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p) continue;
    if((color==="white"&&isBlack(p))||(color==="black"&&isWhite(p))){
      let tempTurn=turn; turn=(color==="white"?"black":"white");
      const moves=getValidMoves(r,c,false);
      turn=tempTurn;
      if(moves.some(m=>m.r===kingPos.r&&m.c===kingPos.c)) return true;
    }
  }
  return false;
}

let gameOver=false;
function checkGameState(){
  if(isKingInCheck(turn)){
    // pr√ºfen ob Z√ºge vorhanden
    let hasMoves=false;
    for(let r=0;r<8;r++) for(let c=0;c<8;c++){
      if(board[r][c] && ((turn==="white"&&isWhite(board[r][c]))||(turn==="black"&&isBlack(board[r][c])))){
        if(getValidMoves(r,c,true).length>0) hasMoves=true;
      }
    }
    if(!hasMoves){
      statusEl.textContent="‚ôõ Schachmatt! "+(turn==="white"?"Schwarz":"Wei√ü")+" gewinnt!";
      gameOver=true;
      return;
    } else {
      statusEl.textContent="‚ö† "+(turn==="white"?"Wei√ü":"Schwarz")+" steht im Schach!";
      return;
    }
  } else {
    // Patt?
    let hasMoves=false;
    for(let r=0;r<8;r++) for(let c=0;c<8;c++){
      if(board[r][c] && ((turn==="white"&&isWhite(board[r][c]))||(turn==="black"&&isBlack(board[r][c])))){
        if(getValidMoves(r,c,true).length>0) hasMoves=true;
      }
    }
    if(!hasMoves){
      statusEl.textContent="ü§ù Patt! Unentschieden!";
      gameOver=true;
      return;
    }
  }
  statusEl.textContent="";
}

render();
</script>
</body>
</html>
